FROM python:3.10-slim

# Set environment variables for development
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Update package list and install development dependencies
RUN apt-get update --fix-missing && apt-get install -y \
    build-essential \
    curl \
    ca-certificates \
    git \
    vim \
    nano \
    htop \
    procps \
    && rm -rf /var/lib/apt/lists/* || \
    (apt-get clean && apt-get update -o Acquire::Retries=3 && apt-get install -y \
    build-essential \
    curl \
    ca-certificates \
    git \
    vim \
    nano \
    htop \
    procps \
    && rm -rf /var/lib/apt/lists/*)

# Configure pip settings with better connectivity options
RUN echo "[global]" > /etc/pip.conf && \
    echo "timeout = 120" >> /etc/pip.conf && \
    echo "retries = 5" >> /etc/pip.conf && \
    echo "trusted-host = pypi.org" >> /etc/pip.conf && \
    echo "               pypi.python.org" >> /etc/pip.conf && \
    echo "               files.pythonhosted.org" >> /etc/pip.conf && \
    echo "index-url = https://pypi.org/simple/" >> /etc/pip.conf

# Set working directory
WORKDIR /app

# Copy requirements first for better caching
COPY ops/requirements-docker.txt /app/requirements-docker.txt

# Install development dependencies
RUN python -m pip install --upgrade pip && \
    python -m pip install --no-cache-dir --timeout 120 --retries 5 -r requirements-docker.txt || \
    python -m pip install --no-cache-dir --timeout 120 --retries 5 --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org -r requirements-docker.txt

# Install development tools
RUN python -m pip install \
    jupyter \
    ipython \
    pytest \
    pytest-cov \
    black \
    flake8 \
    mypy \
    pylint \
    pre-commit

# Install PostgreSQL client and Redis CLI
RUN apt-get update && apt-get install -y \
    postgresql-client \
    redis-tools \
    && rm -rf /var/lib/apt/lists/*

# Copy the rest of the project
COPY . /app

# Create development directories
RUN mkdir -p /app/.vscode /app/.idea /app/logs /app/data

# Set up development environment
RUN echo "alias ll='ls -la'" >> ~/.bashrc && \
    echo "alias python='python3'" >> ~/.bashrc && \
    echo "alias pip='pip3'" >> ~/.bashrc && \
    echo "export PS1='ðŸ³ Î¨QRH-dev \\w \\$ '" >> ~/.bashrc

# Install Flask and Flask-CORS
RUN python -m pip install flask flask-cors

# Copy entrypoint script
COPY ops/docker/entrypoint.dev.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose development ports
EXPOSE 8888
EXPOSE 5000
EXPOSE 8080

# Use entrypoint to start services
ENTRYPOINT ["/entrypoint.sh"]