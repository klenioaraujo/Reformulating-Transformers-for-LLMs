version: '3.8'

services:
  # Development environment for Î¨QRH
  psiqrh-dev:
    build:
      context: ../..
      dockerfile: ops/docker/Dockerfile.dev
      network: host
    container_name: psiqrh-dev
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
      - 1.0.0.1
    extra_hosts:
      - "pypi.org:151.101.193.63"
      - "pypi.python.org:151.101.193.63"
      - "files.pythonhosted.org:151.101.193.63"
    volumes:
      # Mount source code for live development
      - ../..:/app
      # Development tools and cache
      - psiqrh-dev-cache:/app/.cache
      - psiqrh-dev-data:/app/data
      - psiqrh-dev-logs:/app/logs
      # SSH for git operations
      - ~/.ssh:/root/.ssh:ro
      # Git config
      - ~/.gitconfig:/root/.gitconfig:ro
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - TORCH_HOME=/app/.torch
      - JUPYTER_TOKEN=dev123
    ports:
      - "5000:5000"  # Flask API
      - "8888:8888"  # Jupyter notebook
      - "8080:8080"  # Development server
    stdin_open: true
    tty: true
    depends_on:
      - psiqrh-dev-db
      - psiqrh-dev-redis

  # Development database (if needed)
  psiqrh-dev-db:
    image: postgres:15
    container_name: psiqrh-dev-db
    environment:
      - POSTGRES_DB=psiqrh_dev
      - POSTGRES_USER=dev
      - POSTGRES_PASSWORD=dev123
    ports:
      - "5432:5432"
    volumes:
      - psiqrh-dev-db-data:/var/lib/postgresql/data
      - ../../ops/docker/init-postgres.sql:/docker-entrypoint-initdb.d/init.sql

  # Redis for caching (if needed)
  psiqrh-dev-redis:
    image: redis:7-alpine
    container_name: psiqrh-dev-redis
    ports:
      - "6379:6379"

  # Frontend with Nginx
  psiqrh-dev-frontend:
    build:
      context: ../..
      dockerfile: ops/docker/Dockerfile.frontend
    container_name: psiqrh-dev-frontend
    ports:
      - "3000:80"
      - "8081:80"
    depends_on:
      - psiqrh-dev

# Volumes for development data persistence
volumes:
  psiqrh-dev-cache:
    driver: local
  psiqrh-dev-data:
    driver: local
  psiqrh-dev-logs:
    driver: local
  psiqrh-dev-db-data:
    driver: local

# Development network
networks:
  default:
    name: psiqrh-dev-network
    driver: bridge